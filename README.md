# DASK Metadata Capture

A script that takes the output of Amal Gueroudji's [Mofka-Dask coupler](https://github.com/GueroudjiAmal/MofkaDask/) to consolidate the generated `.csv` files into a singular, object-focused output.

Expected inputs:
- `-s` `--sched_file` : default `scheduler_transition.csv`
- `-w` `--worker_file` : default `workers.csv`
- `-t` `--worker_trans_file` : default `worker_transition.csv`
- `-x` `--worker_xfer_file` : default `worker_transfer.csv`
- `-o` `--output_file` : default `compiled_tasks.txt`
- `-c` `--output_compressed` : default `compressed_out.pickle` 

Usage:
```bash
python dask_capture.py -s scheduler_transition.csv -w workers.csv -t worker_transition.csv -x worker_transfer.csv -o compiled_tasks.txt
```

Note the dependencies that are described by `pyproject.toml`, until this scripted is packaged.

## Background
The Mofka-Dask coupler generates a series of `.csv` files based on the process that generated the event and the type of event (e.g. `scheduler_transition.csv` describes the transition of any `Task` states as witnessed by the scheduler, while `worker_transfer.csv` describes the transfer of files as witnessed by a worker.) 

In order for this data to be most useful, it should be collected in a centralized place.
This way, metadata from other sources (such as Darshan) can be consolidated with all the metadata available from DASK.

This script is being developed using the example outputs generated by Amal Gueroudji's example runs, all available [here](https://github.com/GueroudjiAmal/XPDaMoDa).

## Documentation
(To likely be moved to a different location in the future.)

### Classes

Implemented in `dask_md_objs.py`.

- [TaskState](#taskstate)
- [EventSource](#eventsource)
- [SchedulerEvent](#schedulerevent)
- [WXferEvent](#wxferevent)
- [Task](#task)
- [TaskHandler](#taskhandler)

#### TaskState

Subclass of `Enum`. Describes the possible states of a `Task` :

- Released
- Waiting
- Queued
- Processing
- Memory
- Forgotten

#### EventSource

Describes source information of an event.

Variables:
- `addr` : the ip address of the source of an event update.
- `stim_id` : the stimulus type of the event update. 

(TODO : examples or Enum to describe stimulus type)

#### SchedulerEvent

Variables:
- `t_event` (`DateTime.datetime`) : Date-time of the event message
- `t_begins` (`DateTime.datetime` or `None`) : Date-time of the `begins` field in a scheduler event.
- `t_ends` (`DateTime.datetime` or `None`) : Date-time of the `ends` field in a scheduler event.
- `start` (`TaskState`) : Starting state of the task described by the scheduler event.
- `finish` (`TaskState`) : Ending state of the task described by the scheduler event.
- `source` (`EventSource`) : Source of the event described by the scheduler event.
- `task_id` (`str`) : ID of the task whose transition is described by the scheduler event.

#### WXferEvent

Variables:
- `start` (`DateTime.datetime`)
- `stop` (`DateTime.datetime`)
- `middle` (`DateTime.datetime`)
- `duration` (`float`)
- `keys` (`Dict[str,int]`) : Dictionary containing the `keys` information from `worker_transfer.csv`. The dictionary is generated by `eval`ing the data directly.  - `total` (`int`)
- `bandwidth` (`float`)
- `compressed` (`float`)
- `requestor` (`str`) : IP address representing the `who` column of `worker_transfer.csv`. The other worker involved in this transfer event.
- `fulfiller` (`str`) : IP address representing the `called_from` column of `worker_transfer.csv`. The worker that noted this transfer event.
- `transfer_type` (`TransferTypeEnum`) : The type of transfer this event describes; can be either `INCOMING` or `OUTGOING`.
- `time` (`DateTime.datetime`) : The time this event was noted.

TODO: unknown what the int in `keys` is; this needs to be found from the Mofka-Dask code directly.

Methods:
- `is_only_1_task` : 
    - Inputs: None
    - Output: `bool`
    - Summary: Returns whether this Worker Transfer Event only relates to one task.
- `n_tasks` :
    - Inputs: None
    - Output: `int`
    - Summary: Returns how many tasks this Worker Transfer Event relates to.
- `get_key_name` :
    - Inputs: `i (int)`
    - Output: `str`
    - Summary: Given an integer index, returns the name of that key in its list of keys.

#### Task

TODO

#### TaskHandler

TODO